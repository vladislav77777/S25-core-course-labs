# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

Let's explore Secrets:

### Step 1: Create a secret using `kubectl`

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs> kubectl create secret generic my-secret --from-literal=MY_PASS=supersecurepassword
secret/my-secret created

PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs> kubectl get secrets
NAME        TYPE     DATA   AGE
my-secret   Opaque   1      4s
```

### Step 2: Verify and decode secret

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs> kubectl get secret my-secret -o jsonpath="{.data.MY_PASS}"
c3VwZXJzZWN1cmVwYXNzd29yZA==

PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs> [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("c3VwZXJzZWN1cmVwYXNzd29yZA=="))
supersecurepassword
```

### Step 3: Manage secrets with Helm

Let's deploy:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> helm upgrade --install python-app .       
Release "python-app" does not exist. Installing it now.
NAME: python-app
LAST DEPLOYED: Thu Mar  6 21:46:27 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-app,app.kubernetes.io/instance=python-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
```

And check:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s> kubectl get pods                                           
NAME                          READY   STATUS    RESTARTS   AGE
python-app-675dc556d7-8xg4b   1/1     Running   0          87s
python-app-675dc556d7-cd2jd   1/1     Running   0          91s
python-app-675dc556d7-hbthr   1/1     Running   0          84s

PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s> kubectl exec python-app-675dc556d7-8xg4b -- printenv | Select-String "APP_PASSWORD"

APP_PASSWORD=supersecurepassword
```

## Task 2: Vault secret management system

### 1) Set secrets in vault

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
python-app-675dc556d7-8xg4b             1/1     Running   0          60m
python-app-675dc556d7-cd2jd             1/1     Running   0          60m
python-app-675dc556d7-hbthr             1/1     Running   0          60m
vault-0                                 1/1     Running   0          3m4s
vault-agent-injector-66f45b5fd5-fmpgk   1/1     Running   0          3m4s

PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $  vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-s
ecret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T19:56:36.563587392Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-06T19:56:36.563587392Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

### 2) Configure Kubernetes authentication

```bash
/ $
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
> kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write python-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: python-app
/ $ vault write auth/kubernetes/role/python-app \
> bound_service_account_names=python-app \
> bound_service_account_namespaces=default \
> policies=python-app \
> ttl=24h
Success! Data written to: auth/kubernetes/role/python-app
/ $ exit
```


### 3) Check Vault Secrets 

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s> kubectl exec -it python-app-74ff94778-fknz8 --container python-app -- /bin/sh        
$ cd ..
$ ls
app  boot  etc   lib    media  opt   root  sbin  sys  usr  vault
bin  dev   home  lib64  mnt    proc  run   srv   tmp  var
$ cat vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-06T19:56:36.563587392Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

## Bonus Task: Resource Management and Environment Variables

I have configured CPU and memory requests and limits for both Helm charts:
```text
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "100m"
    memory: "128Mi"
```

To validate resource limits:
```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\js-app> kubectl describe deployments.apps js-app       
Name:                   js-app
Namespace:              default
CreationTimestamp:      Thu, 06 Mar 2025 23:42:52 +0300
Labels:                 app.kubernetes.io/instance=js-app
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=js-app
                        app.kubernetes.io/version=1.16.0
                        helm.sh/chart=js-app-0.1.0
Annotations:            deployment.kubernetes.io/revision: 1
                        meta.helm.sh/release-name: js-app
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=js-app,app.kubernetes.io/managed-by=Helm,app.kubernetes.io/name=js-app,app.kubernetes.io/version=1.16.0
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable   
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=js-app
                    app.kubernetes.io/managed-by=Helm
                    app.kubernetes.io/name=js-app
                    app.kubernetes.io/version=1.16.0
                    helm.sh/chart=js-app-0.1.0
  Service Account:  js-app
  Containers:
   js-app:
    Image:      vladis7love/app_js:latest
    Port:       8080/TCP
    Host Port:  0/TCP
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:
      PASSWORD:  supersecurepassword_in_JS_APP
    Mounts:      <none>
  Volumes:       <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   js-app-5cff9b8b4c (3/3 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  16s   deployment-controller  Scaled up replica set js-app-5cff9b8b4c from 0 to 3
```

Environment variables are managed using Helm named templates in `_helpers.tpl`:

```bash
{{- define "common.env" }}
- name: PASSWORD
  value: {{ .Values.PASSWORD | quote }}
{{ end }}
```

So let's verify environment variables are set inside the running pod:
```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\js-app> kubectl get pods     
NAME                                    READY   STATUS    RESTARTS   AGE
js-app-5cff9b8b4c-lfg7l                 1/1     Running   0          38s
js-app-5cff9b8b4c-qmsm9                 1/1     Running   0          38s
js-app-5cff9b8b4c-r4xlx                 1/1     Running   0          38s
vault-0                                 1/1     Running   0          51m
vault-agent-injector-66f45b5fd5-fmpgk   1/1     Running   0          51m

PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\js-app> kubectl exec js-app-5cff9b8b4c-lfg7l -- printenv | Select-String "PASSWORD"    

PASSWORD=supersecurepassword_in_JS_APP
```

All variables:
```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\js-app> kubectl exec -it js-app-5cff9b8b4c-lfg7l -- env     
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=js-app-5cff9b8b4c-lfg7l
TERM=xterm
PASSWORD=supersecurepassword_in_JS_APP
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8201_TCP=tcp://10.102.151.118:8201
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.102.244.18:443
JS_APP_SERVICE_PORT=8080
JS_APP_PORT_8080_TCP=tcp://10.110.104.28:8080
PYTHON_APP_SERVICE_HOST=10.108.167.235
PYTHON_APP_PORT_5000_TCP_PORT=5000
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.102.244.18
JS_APP_SERVICE_HOST=10.110.104.28
JS_APP_PORT_8080_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT=443
PYTHON_APP_PORT_5000_TCP_ADDR=10.108.167.235
VAULT_PORT_8200_TCP=tcp://10.102.151.118:8200
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
PYTHON_APP_SERVICE_PORT=5000
PYTHON_APP_SERVICE_PORT_HTTP=5000
VAULT_SERVICE_PORT=8200
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
JS_APP_PORT=tcp://10.110.104.28:8080
PYTHON_APP_PORT=tcp://10.108.167.235:5000
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT=tcp://10.102.151.118:8200
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.102.244.18
JS_APP_PORT_8080_TCP_PORT=8080
VAULT_SERVICE_PORT_HTTP=8200
VAULT_PORT_8201_TCP_ADDR=10.102.151.118
JS_APP_PORT_8080_TCP_ADDR=10.110.104.28
KUBERNETES_PORT_443_TCP_PORT=443
JS_APP_SERVICE_PORT_HTTP=8080
KUBERNETES_SERVICE_HOST=10.96.0.1
PYTHON_APP_PORT_5000_TCP=tcp://10.108.167.235:5000
VAULT_PORT_8200_TCP_PORT=8200
VAULT_PORT_8200_TCP_ADDR=10.102.151.118
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.102.244.18:443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
PYTHON_APP_PORT_5000_TCP_PROTO=tcp
VAULT_SERVICE_HOST=10.102.151.118
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
NODE_VERSION=18.18.0
YARN_VERSION=1.22.19
HOME=/home/appuser
```
