# Lab 12: Kubernetes ConfigMaps

## Task 1: Upgrade Application for Persistence

I have changed applications and docker-compose.
We can verify `/visits` endpoint after requests, so after running docker-compose :

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8081/visits
<h1>Number of Visits: 2</h1>
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8081       
<h1>Current Time in Moscow: 2025-03-07 20:19:55</h1>
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8081/visits
<h1>Number of Visits: 3</h1>


PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8082/visits
<h1>Number of Visits: 0</h1>
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8082
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Countdown Timer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Countdown Timer</h1>
    <input type="number" id="minutes" placeholder="Minutes" min="0">
    <input type="number" id="seconds" placeholder="Seconds" min="0" max="59">
    <button id="start">Start</button>
    <button id="reset">Reset</button>
    <div id="timer">00:00</div>
  </div>
  <script src="script.js"></script>
</body>
</html>
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> curl.exe http://localhost:8082/visits
<h1>Number of Visits: 1</h1>
```

So, we can explore bind files for both apps:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> type python_app_visits_data/visits.txt
3
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\monitoring> type js_app_visits_data/visits_js.txt
1
```

## Task 2: ConfigMap Implementation

After creating configmaps in both applications let's explore them:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl get configmaps
NAME                DATA   AGE
js-app-config       1      56s
kube-root-ca.crt    1      103s
python-app-config   1      61s
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl describe configmaps python-app-config
Name:         python-app-config
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: python-app
              meta.helm.sh/release-namespace: default

Data
====
config.json:
----
{
  "app_name": "python-app",
  "log_level": "info",
  "port": 5000
}

BinaryData
====

Events:  <none>
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl describe configmaps js-app-config    
Name:         js-app-config
Namespace:    default
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: js-app
              meta.helm.sh/release-namespace: default

Data
====
config.json:
----
{
  "app_name": "js-app",
  "log_level": "warn",
  "port": 8080
}

BinaryData
====

Events:  <none>
```

Also, we can go inside containers and check the ConfigMap inside the pod:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl get pods 
NAME                         READY   STATUS    RESTARTS   AGE
js-app-59c5569df9-dpb8t      1/1     Running   0          3m11s
js-app-59c5569df9-kzxpl      1/1     Running   0          3m11s
js-app-59c5569df9-vs5fv      1/1     Running   0          3m11s
python-app-9975ff566-442c7   1/1     Running   0          3m16s
python-app-9975ff566-bfrfr   1/1     Running   0          3m16s
python-app-9975ff566-cqb5r   1/1     Running   0          3m16s
vault-0                      1/1     Running   0          4m23s


PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl exec -it python-app-9975ff566-442c7 --container python-app -- /bin/sh 
$ cd ../data
$ ls     
config.json
$ pwd
/data
$ cat config.json
{
  "app_name": "python-app",
  "log_level": "info",
  "port": 5000
}$
```

The same for bonus js app:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl exec -it js-app-59c5569df9-dpb8t --container js-app -- /bin/sh       
/usr/share/app $ cd ..
/usr/share $ cd ../..
/ $ ls
bin    data   dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var
/ $ cd data
/data $ ls
config.json
/data $ cat config.json
{
  "app_name": "js-app",
  "log_level": "warn",
  "port": 8080
}
```

And, finally we can decribe our pods for both applications in order to explore them thoroughly:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app>  kubectl describe pod python-app-9975ff566-442c7
Name:             python-app-9975ff566-442c7
Namespace:        default
Priority:         0
Service Account:  python-app
Node:             minikube/192.168.49.2
Start Time:       Fri, 07 Mar 2025 21:36:07 +0300
Labels:           app.kubernetes.io/instance=python-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=python-app
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=python-app-0.1.0
                  pod-template-hash=9975ff566
Annotations:      vault.hashicorp.com/agent-inject: true
                  vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                  vault.hashicorp.com/role: python-app
Status:           Running
IP:               10.244.0.159
IPs:
  IP:           10.244.0.159
Controlled By:  ReplicaSet/python-app-9975ff566
Containers:
  python-app:
    Container ID:   docker://a16b82ca4d3e55cd775d7dc4c72682d429f9e746b0cf11ac9d0587179c2ad17e
    Image:          vladis7love/app_python:latest
    Image ID:       docker-pullable://vladis7love/app_python@sha256:078f20e41c1058ec0d2c5fd6b75d6c9670ecfe36c899278dd3078e4633019f8b
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 07 Mar 2025 21:36:08 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment Variables from:
      python-app-config  ConfigMap  Optional: false
    Environment:
      APP_PASSWORD:  <set to the key 'password' in secret 'my-secret'>  Optional: false 
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-8vxx5 (ro)     
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      python-app-config
    Optional:  false
  kube-api-access-8vxx5:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true


PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app>  kubectl describe pod js-app-59c5569df9-dpb8t   
Name:             js-app-59c5569df9-dpb8t
Namespace:        default
Priority:         0
Service Account:  js-app
Node:             minikube/192.168.49.2
Start Time:       Fri, 07 Mar 2025 21:36:12 +0300
Labels:           app.kubernetes.io/instance=js-app
                  app.kubernetes.io/managed-by=Helm
                  app.kubernetes.io/name=js-app
                  app.kubernetes.io/version=1.16.0
                  helm.sh/chart=js-app-0.1.0
                  pod-template-hash=59c5569df9
Annotations:      <none>
Status:           Running
IP:               10.244.0.163
IPs:
  IP:           10.244.0.163
Controlled By:  ReplicaSet/js-app-59c5569df9
Containers:
  js-app:
    Container ID:   docker://98ccf9fb38ebe410c7b764aad4d93c5344066f367818e18e96470aa3a5029c1d
    Image:          vladis7love/app_js:latest
    Image ID:       docker-pullable://vladis7love/app_js@sha256:a9dd670a17aa04fcea669134f2213723d57f5a42b2179f6a9b839e38d8d1fc25
    Port:           8080/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 07 Mar 2025 21:36:13 +0300
    Ready:          True
    Restart Count:  0
    Limits:
      cpu:     100m
      memory:  128Mi
    Requests:
      cpu:      100m
      memory:   128Mi
    Liveness:   http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:  http-get http://:http/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment Variables from:
      js-app-config  ConfigMap  Optional: false
    Environment:
      PASSWORD:  supersecurepassword_in_JS_APP
    Mounts:
      /data/config.json from config-volume (ro,path="config.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-22f54 (ro)     
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      js-app-config
    Optional:  false
  kube-api-access-22f54:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
```

## Bonus Task

In previous steps I included the same steps for bonus task.
This is config.json for it

```text
{
  "app_name": "js-app",
  "log_level": "warn",
  "port": 8080
}
```

Also, I've created new environment variable in a running container using the `envFrom` property:

```bash
envFrom:
- configMapRef:
    name: js-app-config
```

So, we can find it along with other environment variables in both applications:

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl exec -it js-app-59c5569df9-dpb8t -- env

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=js-app-59c5569df9-dpb8t
TERM=xterm
config.json={
  "app_name": "js-app",
  "log_level": "warn",
  "port": 8080
}
PASSWORD=supersecurepassword_in_JS_APP
```

```bash
PS C:\Users\Vladi\PycharmProjects\S25-core-course-labs\k8s\python-app> kubectl exec -it python-app-9975ff566-442c7 -- env

PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=python-app-9975ff566-442c7
TERM=xterm
APP_PASSWORD=supersecurepassword
config.json={
  "app_name": "python-app",
  "log_level": "info",
  "port": 5000
}
```
